<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orbital Skill Development Center Portal</title>

  <!-- Firebase SDK (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <style>
    body{margin:0;font-family:Arial, sans-serif;background:#f5f7fb}
    header{background:#0d1b2a;color:#fff;padding:16px;text-align:center}
    header .brand{font-size:20px;font-weight:700}
    header .orbital{font-size:18px;font-weight:700;color:#ffcc00}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media(max-width:768px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
    h2{margin:0 0 10px 0}
    label{display:block;margin-top:10px;font-weight:600}
    input,select{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
    .row{display:flex;gap:10px}
    .btn{margin-top:14px;padding:10px 14px;border:none;border-radius:6px;background:#2f6fed;color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#111}
    .message{margin-top:10px;font-size:14px}
    .dashboard{display:flex;height:calc(100vh - 80px)}
    .sidebar{width:250px;background:#1f2937;color:#fff;padding:18px;box-sizing:border-box}
    .sidebar h3{margin-top:0}
    .sidebar ul{list-style:none;padding:0;margin:10px 0 0 0}
    .sidebar ul li{margin:12px 0;cursor:pointer}
    .sidebar ul li:hover{color:#ffcc00}
    .content{flex:1;padding:20px;background:#f9fafb;overflow:auto}
    .hidden{display:none}
    footer{text-align:center;padding:14px;color:#666}
    .small-note{font-size:13px;color:#6b7280;margin-top:8px}
    .captcha-box{padding:10px;background:#111827;color:#fff;font-weight:700;border-radius:6px;min-width:90px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">Online Examination Application & Fee Portal</div>
    <div class="orbital">Orbital Skill Development Center</div>
  </header>

  <main class="container" id="authSection">
    <div class="grid">
      <!-- Registration Card -->
      <section class="card" id="registerCard">
        <h2>Private Student New Registration</h2>
        <label>Student's Name *</label>
        <input type="text" id="regName" />

        <label>Date Of Birth *</label>
        <input type="date" id="regDob" />

        <label>Father's Name *</label>
        <input type="text" id="regFather" />

        <label>Mother's Name *</label>
        <input type="text" id="regMother" />

        <label>Gender *</label>
        <select id="regGender">
          <option value="">Select</option>
          <option>Female</option>
          <option>Male</option>
          <option>Other</option>
        </select>

        <label>Mobile No *</label>
        <input type="text" id="regMobile" />

        <label>Email *</label>
        <input type="email" id="regEmail" />

        <label>Password *</label>
        <input type="password" id="regPassword" />

        <label>Capacity *</label>
        <select id="regCapacity">
          <option value="">Select</option>
          <option>Regular</option>
          <option>Private</option>
        </select>

        <div style="margin-top:10px">
          <input type="checkbox" id="regAgree" /> I agree to Terms & Conditions <a href="#" onclick="return false">Read</a>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" onclick="register()">Register</button>
          <button class="btn secondary" onclick="resetRegister()">Cancel</button>
        </div>

        <div class="message" id="regMsg"></div>
      </section>

      <!-- Login Card -->
      <section class="card" id="loginCard">
        <h2>Already Registered Private Students</h2>

        <label>Email ID *</label>
        <input type="email" id="loginEmail" />

        <label>Password *</label>
        <input type="password" id="loginPassword" />

        <label>Enter Captcha *</label>
        <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <input type="text" id="loginCaptchaInput" placeholder="Enter code" />
          <div id="loginCaptcha" class="captcha-box">00000</div>
          <button class="btn secondary" type="button" onclick="generateCaptcha()">Refresh</button>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" onclick="login()">Login</button>
          <button class="btn secondary" onclick="resetLogin()">Clear</button>
        </div>

        <div class="small-note"><a href="#" onclick="return false">Forgot UserID / Password ?</a></div>
        <div class="message" id="loginMsg"></div>
      </section>
    </div>
  </main>

  <!-- Dashboard -->
  <div class="dashboard hidden" id="dashboard">
    <div class="sidebar">
      <h3>Menu</h3>
      <ul>
        <li onclick="showSection('personal')">Student's Personal Details</li>
        <li onclick="showSection('exam')">Examination Details</li>
        <li onclick="showSection('status')">Application Status</li>
        <li onclick="showSection('upload')">Upload DMC File</li>
        <li onclick="showSection('password')">Change Password</li>
        <li onclick="logout()">Sign Out</li>
      </ul>
    </div>

    <div class="content">
      <div id="personal" class="section">
        <h2>Admission Form</h2>
        <label>Full Name</label>
        <input type="text" id="name" />

        <label>Father's Name</label>
        <input type="text" id="father" />

        <label>Mother's Name</label>
        <input type="text" id="mother" />

        <label>Date of Birth</label>
        <input type="date" id="dob" />

        <label>Gender</label>
        <select id="gender"><option>Female</option><option>Male</option><option>Other</option></select>

        <label>Address</label>
        <input type="text" id="address" />

        <label>Upload Photo (jpg/png)</label>
        <input type="file" id="photo" accept="image/*" />

        <label>Upload Signature (jpg/png)</label>
        <input type="file" id="signature" accept="image/*" />

        <label>Upload Thumb Impression (jpg/png)</label>
        <input type="file" id="thumb" accept="image/*" />

        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" onclick="saveDetails()">Save Details</button>
          <button class="btn secondary" onclick="clearAdmissionForm()">Clear</button>
        </div>

        <div class="message" id="formMsg"></div>
      </div>

      <div id="exam" class="section hidden"><h2>Examination Details</h2></div>
      <div id="status" class="section hidden"><h2>Application Status</h2></div>
      <div id="upload" class="section hidden"><h2>Upload DMC File</h2></div>
      <div id="password" class="section hidden"><h2>Change Password</h2></div>
    </div>
  </div>

  <footer>© Orbital Skill Development Center — Gurugram, Haryana</footer>

  <script>
    // Firebase Config - replace with your own if needed
    const firebaseConfig = {
      apiKey: "AIzaSyCL_B52kVrkT54FMFmBANjkQrbN065g-KQ",
      authDomain: "orbital4u.firebaseapp.com",
      projectId: "orbital4u",
      storageBucket: "orbital4u.appspot.com",
      messagingSenderId: "88284726348",
      appId: "1:88284726348:web:0d43de2919b592509b60e9"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;

    // Captcha
    function generateCaptcha(){
      const val = Math.floor(10000 + Math.random()*90000);
      const el = document.getElementById('loginCaptcha');
      if(el) el.textContent = val;
    }
    generateCaptcha();
    // auto refresh every 45 seconds (optional)
    setInterval(generateCaptcha, 45000);

    // Utility: show message
    function showMsg(id, text, color='green'){
      const el = document.getElementById(id);
      if(!el) return;
      el.style.color = color;
      el.innerText = text;
    }

    // Reset register form
    function resetRegister(){
      document.getElementById('regName').value = '';
      document.getElementById('regDob').value = '';
      document.getElementById('regFather').value = '';
      document.getElementById('regMother').value = '';
      document.getElementById('regGender').value = '';
      document.getElementById('regMobile').value = '';
      document.getElementById('regEmail').value = '';
      document.getElementById('regPassword').value = '';
      document.getElementById('regCapacity').value = '';
      document.getElementById('regAgree').checked = false;
      showMsg('regMsg','');
    }

    // Reset login form
    function resetLogin(){
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginCaptchaInput').value = '';
      showMsg('loginMsg','');
      generateCaptcha();
    }

    // Register function (complete)
    async function register(){
      showMsg('regMsg','Processing...', 'black');

      const name = document.getElementById('regName').value.trim();
      const dob = document.getElementById('regDob').value;
      const father = document.getElementById('regFather').value.trim();
      const mother = document.getElementById('regMother').value.trim();
      const gender = document.getElementById('regGender').value;
      const mobile = document.getElementById('regMobile').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const capacity = document.getElementById('regCapacity').value;
      const agree = document.getElementById('regAgree').checked;

      if(!name || !dob || !father || !mother || !gender || !mobile || !email || !password || !capacity){
        showMsg('regMsg','Please fill all required fields.', 'red');
        return;
      }
      if(!agree){
        showMsg('regMsg','Please accept Terms & Conditions.', 'red');
        return;
      }

      try{
        // create user in Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        currentUser = userCredential.user;

        // save student data in Firestore
        await db.collection('students').doc(currentUser.uid).set({
          name, dob, father, mother, gender, mobile, email, capacity,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMsg('regMsg','Registration successful! Please login.', 'green');
        resetRegister();
      } catch(err){
        showMsg('regMsg', err.message || 'Registration failed', 'red');
      }
    }

    // Login function (complete with captcha)
    async function login(){
      showMsg('loginMsg','Processing...', 'black');

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const captchaInput = document.getElementById('loginCaptchaInput').value.trim();
      const captchaVal = document.getElementById('loginCaptcha').textContent.trim();

      if(!email || !password || !captchaInput){
        showMsg('loginMsg','Please fill all fields.', 'red');
        return;
      }
      if(captchaInput !== captchaVal){
        showMsg('loginMsg','Invalid captcha. Please try again.', 'red');
        generateCaptcha();
        return;
      }

      try{
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = userCredential.user;
        showMsg('loginMsg','Login successful!', 'green');

        // show dashboard
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');

        // load existing student data into admission form if exists
        loadStudentData();
      } catch(err){
        showMsg('loginMsg', err.message || 'Login failed', 'red');
      }
    }

    // Auth state listener (keeps currentUser updated)
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if(user){
        // if user is logged in, show dashboard
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        loadStudentData();
      } else {
        // show auth section
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('authSection').classList.remove('hidden');
      }
    });

    // Logout
    function logout(){
      auth.signOut();
      currentUser = null;
      resetLogin();
      resetRegister();
      // show auth section
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('authSection').classList.remove('hidden');
    }

    // Show section in dashboard
    function showSection(id){
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      const el = document.getElementById(id);
      if(el) el.classList.remove('hidden');
    }

    // Load student data into admission form (if exists)
    async function loadStudentData(){
      if(!currentUser) return;
      try{
        const doc = await db.collection('students').doc(currentUser.uid).get();
        if(doc.exists){
          const data = doc.data();
          if(data.name) document.getElementById('name').value = data.name;
          if(data.father) document.getElementById('father').value = data.father;
          if(data.mother) document.getElementById('mother').value = data.mother;
          if(data.dob) document.getElementById('dob').value = data.dob;
          if(data.gender) document.getElementById('gender').value = data.gender;
          if(data.address) document.getElementById('address').value = data.address;
        }
      } catch(err){
        console.error('loadStudentData error', err);
      }
    }

    // Clear admission form
    function clearAdmissionForm(){
      document.getElementById('name').value = '';
      document.getElementById('father').value = '';
      document.getElementById('mother').value = '';
      document.getElementById('dob').value = '';
      document.getElementById('gender').value = '';
      document.getElementById('address').value = '';
      document.getElementById('photo').value = '';
      document.getElementById('signature').value = '';
      document.getElementById('thumb').value = '';
      showMsg('formMsg','');
    }

    // Save admission form details and upload files to Storage (complete)
    async function saveDetails(){
      const msgId = 'formMsg';
      showMsg(msgId, 'Saving...', 'black');

      if(!currentUser){
        showMsg(msgId, 'You must be logged in to save details.', 'red');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const father = document.getElementById('father').value.trim();
      const mother = document.getElementById('mother').value.trim();
      const dob = document.getElementById('dob').value;
      const gender = document.getElementById('gender').value;
      const address = document.getElementById('address').value.trim();

      if(!name || !father || !mother || !dob || !gender || !address){
        showMsg(msgId, 'Please fill all required fields in admission form.', 'red');
        return;
      }

      const photoFile = document.getElementById('photo').files[0];
      const signatureFile = document.getElementById('signature').files[0];
      const thumbFile = document.getElementById('thumb').files[0];

      try{
        // Update text fields in Firestore (merge true)
        const studentRef = db.collection('students').doc(currentUser.uid);
        await studentRef.set({
          name, father, mother, dob, gender, address,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Upload files to Storage and save URLs
        const uploads = {};

        if(photoFile){
          const photoRef = storage.ref().child(`students/${currentUser.uid}/photo_${Date.now()}`);
          const snap = await photoRef.put(photoFile);
          uploads.photoURL = await snap.ref.getDownloadURL();
        }
        if(signatureFile){
          const sigRef = storage.ref().child(`students/${currentUser.uid}/signature_${Date.now()}`);
          const snap = await sigRef.put(signatureFile);
          uploads.signatureURL = await snap.ref.getDownloadURL();
        }
        if(thumbFile){
          const thumbRef = storage.ref().child(`students/${currentUser.uid}/thumb_${Date.now()}`);
          const snap = await thumbRef.put(thumbFile);
          uploads.thumbURL = await snap.ref.getDownloadURL();
        }

        // If any uploads done, merge URLs into Firestore
        if(Object.keys(uploads).length){
          await studentRef.set(uploads, { merge: true });
        }

        showMsg(msgId, 'Admission details saved successfully!', 'green');
      } catch(err){
        showMsg(msgId, err.message || 'Failed to save details', 'red');
      }
    }
  </script>
</body>
</html>
