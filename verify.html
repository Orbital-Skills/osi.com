<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Portal | OSD</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --theme-purple: #6a1b9a;
            --theme-bg: #f4f4f4;
            --text-color: #333;
            --success-color: #2e7d32;
            --error-color: #d32f2f;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(to bottom, #7b1fa2 40%, #f5f5f5 40%);
            min-height: 100vh;
            margin: 0; padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 100px;
        }

        .card-container {
            background: white;
            width: 90%;
            max-width: 850px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            margin-bottom: 50px;
        }

        .floating-logo-container {
            position: absolute;
            top: 0; left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            border: 4px solid white;
        }

        .floating-logo-container img {
            width: 220px;
            height: auto;
        }

        .tabs-header {
            display: flex;
            width: 100%;
            height: 60px;
            overflow: hidden;
            border-radius: 8px 8px 0 0;
        }

        .tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.3s;
        }
        .tab-inactive { background-color: white; color: red; border-bottom: 1px solid #ddd; }
        .tab-inactive:hover { background-color: #e0e0e0; }
        .tab-active { background-color: green; color: white; }

        .tab-content {
            padding: 40px;
            position: relative;
            background-image: url('https://raw.githubusercontent.com/Orbital-Skills/osi.com/main/LOGO.png'); 
            background-repeat: no-repeat;
            background-position: center;
            background-size: 500px;
            display: none;
        }
        
        .tab-content::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.92); z-index: 1;
        }

        .form-area { position: relative; z-index: 2; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        .input-group { margin-bottom: 20px; position: relative; }
        
        .input-group label {
            display: block; color: #444; font-weight: 700; font-size: 14px; margin-bottom: 8px;
        }
        .input-group label span { color: #d32f2f; }

        .input-group input {
            width: 100%; padding: 12px 15px; font-size: 15px;
            border: 1px solid #ccc; border-radius: 4px;
            background: #fdfdfd; box-sizing: border-box; transition: 0.2s;
        }

        .input-group input:focus {
            outline: none; border-color: var(--theme-purple);
            box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.1);
        }
        
        /* Validation Styles */
        .input-group input.valid { border-color: var(--success-color); background: #e8f5e9; }
        .input-group input.invalid { border-color: var(--error-color); background: #ffebee; }

        .field-msg {
            font-size: 12px; font-weight: 600; margin-top: 4px; display: block; min-height: 18px;
        }
        .msg-success { color: var(--success-color); }
        .msg-error { color: var(--error-color); }
        .checking { color: #f57c00; }

        .row { display: flex; gap: 20px; }
        .col { flex: 1; }
        @media(max-width: 600px) { .row { flex-direction: column; gap: 0; } }

        .verify-btn {
            background: linear-gradient(to right, #7b1fa2, #9c27b0);
            color: white; border: none; width: 100%; padding: 15px;
            font-size: 16px; font-weight: 800; text-transform: uppercase;
            border-radius: 5px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s; margin-top: 10px;
            opacity: 0.5; pointer-events: none; /* Disabled initially */
        }
        .verify-btn.active-btn {
            opacity: 1; pointer-events: all; cursor: pointer;
        }
        .verify-btn:hover { transform: translateY(-2px); }

        .result-box {
            display: none; margin-top: 30px; border-top: 2px dashed #ddd; padding-top: 20px; text-align: center;
        }
        .success-badge {
            background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 4px;
            font-weight: bold; margin-bottom: 20px; display: inline-block; width: 100%; box-sizing: border-box;
        }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .data-lbl { font-weight: 600; color: #555; width: 40%; }
        .data-val { font-weight: 700; color: #000; }

        @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform: translateY(0);} }

        .loader { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            color: white; text-align: center; padding-top: 40vh; font-size: 20px;
        }
    </style>
</head>
<body>

    <div id="loader-overlay" class="loader">
        <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>

    <div class="card-container">
        <div class="floating-logo-container">
            <img src="https://raw.githubusercontent.com/Orbital-Skills/osi.com/main/LOGO.png" alt="OSD Logo">
        </div>

        <div class="tabs-header">
            <div class="tab tab-inactive" onclick="switchTab('qr')">
                <i class="fas fa-qrcode" style="margin-right: 8px;"></i> QR-Code Verification
            </div>
            <div class="tab tab-active" onclick="switchTab('manual')">
                <i class="fas fa-file-alt" style="margin-right: 8px;"></i> Certificate Verification
            </div>
        </div>

        <div id="qr-tab" class="tab-content">
            <div class="form-area" style="text-align: center;">
                <h3 style="color:#555;">Scan QR Code</h3>
                <p>Use your camera to scan the QR code.</p>
                <button class="verify-btn active-btn" style="background:#455a64;" onclick="alert('Camera requires HTTPS context.')">
                    <i class="fas fa-camera"></i> Open Scanner
                </button>
            </div>
        </div>

        <div id="manual-tab" class="tab-content active">
            <div class="form-area">
                
                <div id="input-section">
                    <!-- Step 1: Roll No Verification -->
                    <div class="input-group">
                        <label>Enter Roll / Registration No <span>*</span></label>
                        <!-- Added onblur event to fetch data -->
                        <input type="text" id="v-roll" placeholder="Ex: 2603001" onblur="fetchRollData()">
                        <small id="msg-roll" class="field-msg"></small>
                    </div>

                    <!-- Step 2: Other Details (Initially Disabled) -->
                    <div id="details-section" style="opacity: 0.5; pointer-events: none;">
                        <div class="row">
                            <div class="col input-group">
                                <label>Student Name</label>
                                <input type="text" id="v-name" placeholder="Full Name" onkeyup="validateField(this, 'Name')" disabled>
                                <small id="msg-name" class="field-msg"></small>
                            </div>
                            <div class="col input-group">
                                <label>Father's Name</label>
                                <input type="text" id="v-father" placeholder="Father Name" onkeyup="validateField(this, 'Father')" disabled>
                                <small id="msg-father" class="field-msg"></small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col input-group">
                                <label>Mother's Name</label>
                                <input type="text" id="v-mother" placeholder="Mother Name" onkeyup="validateField(this, 'Mother')" disabled>
                                <small id="msg-mother" class="field-msg"></small>
                            </div>
                            <div class="col input-group">
                                <label>Course Name</label>
                                <input type="text" id="v-course" placeholder="Applied Course" onkeyup="validateField(this, 'Course')" disabled>
                                <small id="msg-course" class="field-msg"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button (Enabled only when all fields match) -->
                    <button id="main-btn" class="verify-btn" onclick="showFinalResult()">
                        VERIFY RECORD <i class="fas fa-arrow-right" style="margin-left:5px;"></i>
                    </button>
                </div>

                <!-- RESULTS DISPLAY -->
                <div id="result-display" class="result-box">
                    <div class="success-badge">
                        <i class="fas fa-check-circle"></i> VERIFIED STUDENT RECORD
                    </div>
                    
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                        <img id="res-photo" src="" style="width: 100px; height: 120px; object-fit: cover; border: 3px solid #ddd; padding: 2px;">
                        
                        <table class="data-table">
                            <tr><td class="data-lbl">Roll No:</td><td class="data-val" id="res-roll"></td></tr>
                            <tr><td class="data-lbl">Name:</td><td class="data-val" id="res-name"></td></tr>
                            <tr><td class="data-lbl">Father Name:</td><td class="data-val" id="res-father"></td></tr>
                            <tr><td class="data-lbl">Mother Name:</td><td class="data-val" id="res-mother"></td></tr>
                            <tr><td class="data-lbl">Course:</td><td class="data-val" id="res-course"></td></tr>
                            <tr><td class="data-lbl">Status:</td><td class="data-val" style="color:green;">PASS</td></tr>
                        </table>
                    </div>
                    
                    <button onclick="location.reload()" style="margin-top:20px; background:transparent; border:none; color: #6a1b9a; text-decoration: underline; cursor:pointer;">
                        Verify Another Student
                    </button>
                </div>

            </div>
        </div>

    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby8NYb0IZguAp1nv56lMDokpQbiiCTkBz9IeYt66_aC3_YVnC9_4t6bXW9kK7aM_nZ_/exec"; 
        
        let fetchedData = null; // To store data temporarily

        function switchTab(mode) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            tabs[0].className = 'tab ' + (mode === 'qr' ? 'tab-active' : 'tab-inactive');
            tabs[1].className = 'tab ' + (mode === 'manual' ? 'tab-active' : 'tab-inactive');
            contents[0].className = mode === 'qr' ? 'tab-content active' : 'tab-content';
            contents[1].className = mode === 'manual' ? 'tab-content active' : 'tab-content';
        }

        // --- STEP 1: Fetch Data by Roll No ---
        async function fetchRollData() {
            const rollInput = document.getElementById('v-roll');
            const msgBox = document.getElementById('msg-roll');
            const roll = rollInput.value.trim();

            if(!roll) return;

            // UI Updates
            msgBox.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking Database...';
            msgBox.className = "field-msg checking";
            rollInput.disabled = true;

            try {
                // Requesting data specifically by Roll No
                // IMPORTANT: Apps Script must handle Action: "FETCH_BY_ROLL"
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ Action: "FETCH_BY_ROLL", RollNo: roll }) 
                });
                
                const data = await response.json();

                if(data.Success) {
                    fetchedData = data.Data; // Store correct data locally
                    
                    // Success UI
                    msgBox.innerHTML = '<i class="fas fa-check"></i> Record Found. Please verify details below.';
                    msgBox.className = "field-msg msg-success";
                    rollInput.classList.add('valid');
                    rollInput.classList.remove('invalid');

                    // Enable other fields
                    const detailsDiv = document.getElementById('details-section');
                    detailsDiv.style.opacity = "1";
                    detailsDiv.style.pointerEvents = "all";
                    
                    // Enable inputs
                    document.getElementById('v-name').disabled = false;
                    document.getElementById('v-father').disabled = false;
                    document.getElementById('v-mother').disabled = false;
                    document.getElementById('v-course').disabled = false;

                } else {
                    throw new Error("Record Not Found");
                }
            } catch (error) {
                fetchedData = null;
                msgBox.innerHTML = '<i class="fas fa-times"></i> Invalid Roll No / Record Not Found.';
                msgBox.className = "field-msg msg-error";
                rollInput.classList.add('invalid');
                rollInput.classList.remove('valid');
                rollInput.disabled = false;
                rollInput.focus();
            }
        }

        // --- STEP 2: Validate Fields Real-time ---
        function validateField(input, fieldKey) {
            if(!fetchedData) return;

            const userVal = input.value.trim().toLowerCase();
            // Assuming API returns keys: Name, Father, Mother, Course
            // If your API returns 'FName' instead of 'Father', map it here:
            let dbKey = fieldKey;
            if(fieldKey === 'Father') dbKey = 'FName'; // Adjust based on your script keys
            if(fieldKey === 'Mother') dbKey = 'MName'; // Adjust based on your script keys
            
            const correctVal = (fetchedData[dbKey] || fetchedData[fieldKey] || "").trim().toLowerCase();
            const msgBox = document.getElementById('msg-' + fieldKey.toLowerCase());

            if(userVal === correctVal) {
                input.classList.add('valid');
                input.classList.remove('invalid');
                msgBox.innerHTML = '<i class="fas fa-check"></i> Match';
                msgBox.className = "field-msg msg-success";
            } else {
                input.classList.add('invalid');
                input.classList.remove('valid');
                if(userVal.length > 0) {
                    msgBox.innerHTML = '<i class="fas fa-times"></i> Incorrect';
                    msgBox.className = "field-msg msg-error";
                } else {
                    msgBox.innerHTML = '';
                }
            }
            
            checkAllFields();
        }

        // --- STEP 3: Enable Button if All Correct ---
        function checkAllFields() {
            const inputs = document.querySelectorAll('#details-section input');
            let allValid = true;
            inputs.forEach(inp => {
                if(!inp.classList.contains('valid')) allValid = false;
            });

            const btn = document.getElementById('main-btn');
            if(allValid) {
                btn.classList.add('active-btn');
                btn.innerHTML = 'VIEW FULL RESULT <i class="fas fa-check-double"></i>';
            } else {
                btn.classList.remove('active-btn');
                btn.innerHTML = 'VERIFY RECORD <i class="fas fa-arrow-right"></i>';
            }
        }

        // --- STEP 4: Show Result ---
        function showFinalResult() {
            if(!fetchedData) return;

            document.getElementById('input-section').style.display = 'none';
            document.getElementById('result-display').style.display = 'block';

            document.getElementById('res-roll').innerText = fetchedData.RollNo;
            document.getElementById('res-name').innerText = fetchedData.Name;
            document.getElementById('res-father').innerText = fetchedData.FName || fetchedData.Father;
            document.getElementById('res-mother').innerText = fetchedData.MName || fetchedData.Mother;
            document.getElementById('res-course').innerText = fetchedData.Course;
            
            if(fetchedData.Photo) {
                document.getElementById('res-photo').src = fetchedData.Photo;
            } else {
                document.getElementById('res-photo').src = "https://via.placeholder.com/150?text=No+Img";
            }
        }
    </script>
</body>
</html>
